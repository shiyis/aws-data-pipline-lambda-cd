AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'aws-data-pipline-lambda-cd

  data pipeline sam sample code

  '
Globals:
  Function:
    Tracing: Active
  Api:
    TracingEnabled: true
Resources:
  MyLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ../../layers
      CompatibleRuntimes:
      - python3.8
  DataPollingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DataPollingFunction
      Handler: app.lambda_handler
      Runtime: python3.8
      Layers:
      - Ref: MyLayer
      Policies:
      - SSMParameterReadPolicy:
          ParameterName: data-pipeline-team3/bearer_token
    Metadata:
      SamResourceId: DataPollingFunction
  PreprocessFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: PreprocessFunction
      Handler: app.lambda_handler
      Runtime: python3.8
      Layers:
      - Ref: MyLayer
    Metadata:
      SamResourceId: PreprocessFunction
  DataLoadingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DataLoadingFunction
      Handler: app.lambda_handler
      Runtime: python3.8
      Layers:
      - Ref: MyLayer
    Metadata:
      SamResourceId: DataLoadingFunction
  DataPollingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: ../../statemachine/data_pipeline.asl.json
      DefinitionSubstitutions:
        DataPollingFunctionArn:
          Fn::GetAtt:
          - DataPollingFunction
          - Arn
        PreprocessFunctionArn:
          Fn::GetAtt:
          - PreprocessFunction
          - Arn
        DataLoadingFunctionArn:
          Fn::GetAtt:
          - DataLoadingFunction
          - Arn
      Events:
        DailyPollingSchedule:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
      Policies:
      - CloudWatchPutMetricPolicy: {}
      - LambdaInvokePolicy:
          FunctionName: ''
Outputs:
  DataPollingStateMachineArn:
    Description: Data Polling State machine ARN
    Value:
      Ref: DataPollingStateMachine
  DataPollingStateMachineRoleArn:
    Description: IAM Role created for Data Pipelining State machine based on the specified
      SAM Policy Templates
    Value:
      Fn::GetAtt:
      - DataPollingStateMachineRole
      - Arn
